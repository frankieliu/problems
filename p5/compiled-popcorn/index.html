<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0>
        <link rel="stylesheet" href="/css/main.css">
        <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.2.0/css/all.css" integrity="sha384-hWVjflwFxL6sNzntih27bfxkr27PmbbK/iSvJ+a4+0owXq79v+lsFkW54bOGbiDQ" crossorigin="anonymous">
    </head>
    <body>
        <div id="main" tabindex="-1">
            <video controls id="myvideo">
                <source src="./video.webm" type="video/webm">
                <track id="mytrack" kind="subtitles" label="mytrack" src="mytrack.vtt" srclang="en" default></track>
                Not good.
            </video>
        </div>
        <div id="sketchCanvas"></div>
        <div id="footnote"></div>

        <script src="js/vendor/jquery-3.3.1.min.js"></script>
        <script src="js/vendor/jquery-ui-1.12.1/jquery-ui.min.js"></script>
        
        <!-- <script src="js/vendor/jquery.hotkeys.js"></script> -->
        <script src="js/popcorn-complete.min.js"></script>
        <script src="js/vendor/p5.min.js"></script>
        <script src="js/vendor/addons/p5.dom.js"></script>
        <!-- 
        <script src="js/vendor/addons/p5.sound.min.js"></script>
        -->
        <script src="js/demos/intro/sketch.js"></script>
        <script src="js/demos/painting/sketch.js"></script>
        <script src="js/demos/forms/sketch.js"></script>
        <script>

         var main = {};
         var $video = $("#myvideo")[0];

         var videoRatio = 1;
         console.log($video.videoHeight, $video.videoWidth);
         
         window.addEventListener('resize', resize, false);

         $video.onloadeddata = function() {
             videoRatio = $video.videoHeight/$video.videoWidth;
             console.log(videoRatio);
             createSketch(main, $video);
             resize();
             setTracks(main, $video);
         };

         function resize() {
             console.log("resizing");
             if ($video.readyState == 4) {
                 videoRatio = $video.videoHeight/$video.videoWidth;
             }
             var windowRatio = window.innerHeight / window.innerWidth; /* browser size */
             console.log(windowRatio, videoRatio);
             if (windowRatio < videoRatio) {
                 if (window.innerHeight > 50) { /* smallest video height */
                     $video.height = window.innerHeight;
                 } else {
                     $video.height = 50;
                 }
                 $video.width = $video.height / videoRatio;
             } else {
                 $video.width = window.innerWidth;
                 $video.height = $video.width * videoRatio;
             }
             console.log($video.width, videoRatio, $video.height);
             main.sketch.resize();
         };
         
         // event listeners for video
         var videoSeeking = false;
         $video.addEventListener(
             "seeking",
             function() {
                 videoSeeking = true;
             });

         $video.addEventListener(
             "seeked",
             function() {
                 videoSeeking = false;
             });
         
         $video.addEventListener(
             "playing",
             function() {
                 $video.setAttribute("controls","controls");
             });

         if (false) {
             $("#main")[0].addEventListener(
                 "keypress", 
                 function(e) {
                     console.log("keypress paused");
                     var env = {
                         main: main,
                         video: $video
                     };
                     main.sketch = new p5(formsSketch(env), "sketchCanvas");
                     $video.pause();
                 }
             );
         }

         function createSketch(main, $video) {
             main.sketch = new p5(formsSketch(
                 {
                     main: main,
                     video: $video
                 },
                 "sketchCanvas"));
         }

         function setTracks(main, $video) {
             // Text tracking
             main.textTrack = $video.textTracks[0];
             main.tt = document.getElementById("mytrack");

             main.cueinfo={};
             if (main.tt.readyState == 2) {
                 doCues.call(main.tt);
             } else {
                 main.tt.onloadeddata = doCues;
             }

         };

         function doCues() {
             console.log("Do cues");
             var textTrack = this.track;
             var cues = textTrack.cues;

             console.log(cues);
             textTrack.oncuechange = function () {
                 var cue = this.activeCues[0];
                 if (cue == null) {
                     console.log("No cue");
                 } else {
                     console.log("On cue " + cue);
                 }
             }

             console.log("Creating a new cue");
             var anew = new VTTCue(10, 150, "My <u>underlined</u> Cue 3");
             anew.id = 'cue_id_3';
             anew.onenter = function () {
                 console.log("Enter " + this.id);
             }
             anew.onexit = function () {
                 console.log("Exit " + this.id);
             }
             textTrack.addCue(anew);
             
             // cueinfo.track3 = anew;
             {
                 var anew = new VTTCue(180, 240, "My <u>underlined</u> Cue 4");
                 anew.id = 'cue_id_4';
                 anew.onenter = function () {
                     console.log("Enter " + this.id);
                 }
                 anew.onexit = function () {
                     console.log("Exit " + this.id);
                 }
                 textTrack.addCue(anew);
             }
             
             for (var j = 0; j < cues.length; j++) {
                 var cue = cues[j];
                 var cueId = cue.id;
                 var cueText = cue.text;
                 // console.log(j, cue, cueId, cueText);
                 if ((cue.id != 'cue_id_3') && (cue.id != 'cue_id_4')) {
                     if (/^\s*{/.test(cueText)) {
                         var s = cueText.replace(/(['"])?([a-z0-9A-Z_]+)(['"])?:/g, '"$2": ');
                         console.log(s);
                         cue.obj = JSON.parse(s);
                         cue.onenter = function() {
                             this.form = main.sketch.startForms(
                                 this.id,
                                 this.obj.pos,
                                 title=this.obj.title,
                                 subject=this.obj.subject
                             );
                             console.log(this.form);
                         };
                         cue.onexit = function() {
                             this.form.container.remove();
                         };
                     } else {
                         cue.onenter = function() {
                             // console.log("Enter " + this.id);
                         };
                         cue.onexit = function() {
                             // console.log("Exit " + this.id);
                         };
                     }
                 }
             }
             
         };

         
        </script>
    </body>
</html>
